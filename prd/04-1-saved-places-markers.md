# PRD: 저장된 장소 지도 마커 표시

## 1. 기능 개요
**핵심 가치:** 사용자가 저장한 장소들을 지도에 마커로 시각화하여 저장된 장소들의 지리적 분포와 위치를 한눈에 파악할 수 있게 한다.

**사용자 이점:** 텍스트 목록만으로는 알기 어려운 저장된 장소들의 공간적 관계를 지도 위에서 직관적으로 이해하고, 탭 한 번으로 장소 상세 정보에 접근할 수 있다.

**상위 기능:** PRD 04-map-visualization (지도 기반 시각화 및 경로 표시)

---

## 2. 페르소나(Persona)
**주 사용자:** 지영(25세, 대학원생)
- **맥락:** 여러 번에 걸쳐 저장한 장소들이 20개 이상 쌓였는데, 어느 지역에 주로 저장했는지 한눈에 보고 싶음
- **목표:** 저장된 장소들이 어디에 몰려 있는지, 가까운 곳에 어떤 장소들이 있는지 지도로 확인하고 싶음
- **동기:** 데이트 계획 시 동선을 효율적으로 짜기 위해 저장한 장소들의 위치 관계 파악 필요
- **제약:** 복잡한 지도 조작은 어려워하고, 마커가 너무 많으면 답답함을 느낌
- **성공 정의:** 저장 화면에서 지도 아이콘 클릭 후 3초 내 모든 저장된 장소가 지도에 표시되고, 마커 클릭 시 장소 정보 즉시 확인 가능

**핵심 Pain Points:**
1. **공간 감각 부족:** 목록으로만 보면 저장된 장소들이 얼마나 떨어져 있는지 모름
2. **접근성 낮음:** 특정 장소 상세 정보를 보려면 목록을 다시 스크롤해야 함
3. **정보 부족:** 지도를 봐도 어떤 마커가 어떤 장소인지 구별하기 어려움

---

## 3. 유저 스토리(User Stories)
- **저장 장소 조회자**로서, 저장한 모든 장소들을 지도에서 마커로 보고 싶다. 그래서 지역별 분포를 한눈에 파악한다.
- **지리 확인자**로서, 지도에서 마커를 탭하면 해당 장소의 기본 정보를 보고 싶다. 그래서 목록으로 돌아가지 않고 빠르게 확인한다.
- **상세 정보 열람자**로서, 마커 정보 패널에서 "상세보기" 버튼을 누르면 장소 상세 화면으로 이동하고 싶다. 그래서 더 많은 정보를 확인한다.
- **현재 위치 활용자**로서, 지도 로딩 시 내 현재 위치를 중심으로 지도가 표시되기를 원한다. 그래서 내 주변에 어떤 저장 장소가 있는지 바로 확인한다.

---

## 4. 유저 플로우(User Flow)

### 4-1. 저장 화면에서 지도 진입 플로우
1. **진입:** "저장" 탭에서 "지도 보기" 아이콘/버튼 탭
2. **위치 권한:** GPS 위치 접근 권한 요청 (이미 허용된 경우 스킵)
3. **지도 로딩:** Kakao Map 초기화 및 현재 위치 중심으로 표시
4. **마커 표시:** SavedPlaces 데이터를 가져와 각 장소를 마커로 표시
5. **화면 조정:** 모든 마커가 화면에 들어오도록 자동 줌 레벨 조정

### 4-2. 마커 상호작용 플로우
1. **마커 탭:** 사용자가 특정 마커를 탭
2. **정보 패널 표시:** 하단에 PlaceMarkerInfo 컴포넌트가 슬라이드 업
3. **기본 정보 확인:** 장소명, 주소, 카테고리, 평점 등 표시
4. **액션 선택:**
   - "상세보기": PlaceDetailScreen으로 네비게이션
   - "닫기" (X): 정보 패널 숨김
5. **다른 마커 탭:** 정보 패널이 새 장소 정보로 업데이트

### 4-3. 에러/빈 상태 플로우
- **저장된 장소 없음:** 빈 지도에 "저장된 장소가 없습니다" 메시지 + 홈 화면으로 유도
- **위치 권한 거부:** 서울시청(37.5665, 126.9780) 기본 위치로 지도 표시
- **네트워크 오류:** "지도를 불러올 수 없습니다. 네트워크 연결을 확인해주세요" 스낵바

---

## 5. 수용 기준(Acceptance Criteria)

| ID | 시나리오 | Given | When | Then |
|----|----------|-------|------|------|
| AC-01 | 지도 로딩 속도 | 저장된 장소 1-50개 | 지도 화면 진입 시 | 3초 이내 모든 마커 표시 완료 |
| AC-02 | 마커 정확성 | 좌표 정보가 있는 저장 장소 | 마커 표시 시 | 실제 위치와 동일한 좌표에 마커 표시 |
| AC-03 | 화면 자동 조정 | 여러 장소 저장됨 | 지도 로딩 시 | 모든 마커가 화면에 보이도록 줌 레벨/중심 자동 조정 |
| AC-04 | 마커 클릭 반응 | 마커가 표시됨 | 마커 탭 시 | 0.3초 이내 PlaceMarkerInfo 컴포넌트 표시 |
| AC-05 | 정보 패널 내용 | 마커 선택됨 | PlaceMarkerInfo 표시 시 | 장소명, 주소, 카테고리, "상세보기" 버튼 포함 |
| AC-06 | 상세 화면 이동 | PlaceMarkerInfo 표시 중 | "상세보기" 버튼 탭 시 | PlaceDetailScreen으로 네비게이션 + placeId 전달 |
| AC-07 | 현재 위치 표시 | 위치 권한 허용됨 | 지도 로딩 시 | 사용자 현재 위치 마커 표시 (저장 장소 마커와 구별) |

---

## 6. 상충/의존성 점검(Conflict Matrix)

| 항목 | 잠재 충돌 | 정책/해결 |
|------|-----------|-----------|
| 마커 개수 vs 성능 | 저장 장소 100개 이상 시 렌더링 느려짐 | Phase 1에서는 모두 표시, 추후 클러스터링 추가 |
| 화면 조정 vs 현재 위치 | 모든 마커 vs 현재 위치 중 어느 쪽 우선? | 현재 위치 중심 + 저장 장소들이 보이도록 줌 조정 |
| 정보 패널 vs 지도 영역 | 패널이 지도 하단을 가림 | 하단 1/3만 차지, 드래그로 접기/펼치기 가능 |
| 데이터 동기화 | 저장 장소 추가/삭제 시 지도 업데이트 | SavedPlacesProvider watch로 자동 반응 |

---

## 7. 기능별 상세 명세

### 7-1. 마커 디자인 (Phase 1: 기본 핀)
```
기본 마커:
- 아이콘: Kakao Map SDK 기본 핀
- 색상: 빨간색 (Kakao 기본)
- 크기: 기본 크기 (변경 없음)
- 라벨: 없음 (탭 시 정보 패널로 표시)

현재 위치 마커:
- 아이콘: 파란색 원형 점
- 크기: 작은 크기 (저장 장소 마커와 구별)
- 라벨: "현재 위치"
```

### 7-2. PlaceMarkerInfo 컴포넌트
```
레이아웃:
┌─────────────────────────────┐
│ [X] 장소명             [❤️]   │
│ 📍 주소 (최대 2줄)           │
│ 🏷️ 카테고리                  │
│ ⭐ 평점 (있는 경우)          │
│ [상세보기]                   │
└─────────────────────────────┘

인터랙션:
- 드래그: 위로 드래그 시 확장, 아래로 드래그 시 축소/닫기
- [X] 버튼: 패널 닫기 (마커 선택 해제)
- [상세보기]: PlaceDetailScreen으로 이동
- [❤️] 버튼: 저장 해제 (확인 다이얼로그)
```

### 7-3. 데이터 흐름
```
MapScreen
  ↓ watch
SavedPlacesProvider (SavedPlacesState)
  ↓ places: List<Place>
_buildMarkers(places)
  ↓ Place → Marker 변환
KakaoMap widget (markers parameter)
  ↓ onMarkerTap
MapProvider.selectPlace(placeId)
  ↓ selectedPlaceId 업데이트
PlaceMarkerInfo widget (placeId)
```

### 7-4. 지도 초기 설정
```dart
// 지도 옵션
KakaoMapOption(
  position: currentLocation ?? defaultSeoul, // 현재 위치 또는 서울시청
  zoomLevel: 16, // 초기 줌 레벨 (상세 거리)
  mapType: MapType.normal, // 일반 지도
)

// 카메라 자동 조정
if (savedPlaces.isNotEmpty) {
  final bounds = _calculateBounds(savedPlaces);
  controller.fitBounds(bounds, padding: 50);
}
```

---

## 8. KPI / 측정 지표

### 8-1. 사용성 지표
- **지도 진입률:** 저장 화면 방문 → 지도 보기 클릭 비율 ≥ 30%
- **마커 상호작용률:** 지도 표시 → 마커 클릭 비율 ≥ 50%
- **상세 화면 전환율:** 마커 클릭 → 상세보기 전환 비율 ≥ 40%

### 8-2. 성능 지표
- **지도 로딩 시간:** 지도 화면 진입 → 모든 마커 표시 p90 ≤ 3초
- **마커 반응 시간:** 마커 탭 → 정보 패널 표시 p95 ≤ 300ms
- **메모리 사용량:** 저장 장소 50개 표시 시 메모리 증가 ≤ 50MB

### 8-3. 기술 지표
- **마커 정확도:** 표시된 마커 위치 오차 평균 ≤ 10m
- **데이터 동기화:** 저장 장소 추가/삭제 → 지도 업데이트 ≤ 1초
- **에러율:** 지도 로딩 실패율 ≤ 1%

---

## 9. UI/UX 가이드라인

### 9-1. 지도 화면 레이아웃
```
┌─────────────────────────────┐
│ [← 뒤로] 저장된 장소 [📍현재위치] │ ← 상단 바
├─────────────────────────────┤
│                             │
│        지도 영역             │
│      (마커들 표시)           │ ← 메인 지도
│                             │
│                             │
├─────────────────────────────┤
│ 📍 선택된 장소 정보           │ ← PlaceMarkerInfo
│    (마커 클릭 시 표시)        │   (슬라이드 업/다운)
└─────────────────────────────┘
```

### 9-2. 마커 클릭 전/후 상태
```
클릭 전:
- 모든 마커 기본 크기
- 정보 패널 숨김

클릭 시:
- 선택된 마커 약간 확대 (1.2배)
- 정보 패널 0.3초 애니메이션으로 슬라이드 업
- 지도 중심을 선택된 마커로 부드럽게 이동

클릭 후:
- 다른 마커 클릭 시 정보 패널 내용만 업데이트 (애니메이션 없음)
- 지도 영역 클릭 시 정보 패널 닫힘 + 마커 선택 해제
```

### 9-3. 빈 상태 UI
```
┌─────────────────────────────┐
│ [← 뒤로] 저장된 장소          │
├─────────────────────────────┤
│                             │
│         📍                  │
│    저장된 장소가 없습니다     │
│                             │
│  [장소 탐색하러 가기]        │ ← 홈 화면으로 이동
│                             │
└─────────────────────────────┘
```

---

## 10. 접근성 / 국제화

### 10-1. 접근성
- **시각 장애:** 마커 선택 시 TTS로 장소명과 주소 읽어주기
- **색맹 대응:** Phase 1에서는 기본 핀 사용으로 문제없음 (추후 커스텀 마커 시 고려)
- **운동 장애:** 마커 터치 영역 최소 48x48dp 보장
- **저시력:** 정보 패널 텍스트 크기 시스템 설정 따름

### 10-2. 국제화
- **지도 언어:** Kakao Map 기본 언어 (한국어)
- **UI 텍스트:** 다국어 지원 (`app_localizations.dart`)
  - "저장된 장소" → "Saved Places"
  - "상세보기" → "View Details"
  - "현재 위치" → "Current Location"

---

## 11. 외부 의존성

### 11-1. 내부 의존성
- `SavedPlacesProvider`: 저장된 장소 목록 제공
- `MapProvider`: 지도 상태 관리 (selectedPlaceId)
- `PlaceMarkerInfo`: 마커 클릭 시 정보 표시 위젯
- `KakaoMapWidget`: Kakao Map SDK Flutter wrapper

### 11-2. 외부 의존성
- **Kakao Map SDK:** 지도 표시 및 마커 렌더링
- **Geolocator:** 현재 위치 가져오기
- **Permission Handler:** 위치 권한 요청

---

## 12. 제약사항 및 가정

### 12-1. 기술 제약
- 저장된 장소 좌표 필수: `latitude`, `longitude`가 null인 장소는 지도에 표시 안 됨
- Kakao Map SDK 초기화 필수: `.env.dev`에 `KAKAO_NATIVE_APP_KEY` 설정 필요
- 네이티브 Platform View 사용: Hot Restart 필요 (Hot Reload 제한)

### 12-2. 가정
- 저장된 장소 개수는 대부분 100개 이하 (클러스터링 없이도 충분)
- 모든 저장 장소에는 유효한 좌표가 있음 (링크 분석 시 자동 추출)
- 사용자 대부분이 위치 권한을 허용할 것으로 예상

---

## 13. Phase별 구현 계획

### Phase 1 (현재 작업): 기본 마커 표시
- ✅ SavedPlacesProvider에서 데이터 가져오기
- ✅ 기본 핀으로 마커 표시
- ✅ 마커 클릭 시 PlaceMarkerInfo 표시
- ✅ 현재 위치 중심으로 지도 초기화
- ✅ 화면 자동 조정 (모든 마커 포함)

### Phase 2 (향후 추가): 고급 기능
- 🔲 카테고리별 커스텀 마커 아이콘
- 🔲 마커 클러스터링 (100개 이상 시)
- 🔲 카테고리 필터링 (맛집만, 카페만 등)
- 🔲 거리 필터링 (현재 위치 N km 이내)
- 🔲 마커 검색 기능

---

## 14. 용어 사전(Glossary)
- **SavedPlacesProvider:** 저장된 장소 목록을 관리하는 Riverpod StateNotifier
- **PlaceMarkerInfo:** 마커 클릭 시 하단에 표시되는 장소 정보 위젯
- **MapProvider:** 지도 상태(선택된 마커, 현재 위치 등)를 관리하는 Provider
- **KakaoMapWidget:** Kakao Map SDK를 Flutter에서 사용하기 위한 PlatformView 위젯
- **markerId:** 마커를 식별하는 고유 ID (`place.id` 사용)

---

## Changelog
- 2025-01-13: 초기 문서 작성 (작성자: Claude Code)
- 연관 문서: PRD 04-map-visualization (지도 기반 시각화)
- 버전: v1.0
