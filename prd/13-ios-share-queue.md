# PRD: iOS 공유 기능 - 일괄 분석 큐 시스템

## 1. 기능 개요
**핵심 가치:** 사용자가 여러 SNS 링크를 iOS 공유 기능으로 Hotly에 전송하면, 큐에 임시 저장 후 일괄적으로 고품질 AI 분석을 수행하여 정확한 장소 정보를 제공한다.

**사용자 이점:**
- 즉시 분석 대기 없이 여러 링크를 빠르게 공유 가능
- 일괄 처리로 분석 품질 향상 및 배터리/데이터 효율성 증대
- 앱을 실행한 시점에 한번에 결과 확인 및 저장

---

## 2. 페르소나(Persona)
**주 사용자:** 수진(28세, 패션 에디터)
- **맥락:** 출퇴근 중 인스타그램에서 데이트 장소 5-10개를 발견하지만, 하나씩 분석하며 기다리기 불편함
- **목표:** 발견한 링크를 빠르게 공유만 해두고, 나중에 앱 실행 시 한번에 확인하여 저장
- **동기:** 업무 중 짬짬이 링크 수집, 저녁에 한번에 정리
- **제약:** 이동 중 네트워크 불안정, 분석 대기 시간 낭비 싫어함
- **성공 정의:** 3-5개 링크를 1분 내 공유 완료, 저녁 귀가 후 5분 내 전체 분석 결과 확인 및 저장

**핵심 Pain Points:**
1. **즉시 분석 부담:** 링크 하나당 20-30초 분석 대기가 여러 개 누적되면 3-5분 소요
2. **반복 작업 피로:** 공유 → 대기 → 저장을 여러 번 반복하는 번거로움
3. **분석 품질 저하:** 빠른 처리를 위한 간소화로 정확도 희생 우려

---

## 3. 유저 스토리(User Stories)
- **링크 수집자**로서, 인스타그램에서 여러 장소를 발견하면 빠르게 공유만 하고 싶다. 그래서 분석 대기 시간을 절약한다.
- **일괄 처리자**로서, 수집한 링크를 한번에 분석하고 싶다. 그래서 네트워크/배터리를 효율적으로 사용한다.
- **품질 중시자**로서, 분석 시간이 조금 걸리더라도 정확한 정보를 받고 싶다. 그래서 재분석이나 수정 작업을 최소화한다.
- **결과 확인자**로서, 분석 완료된 여러 장소를 한 화면에서 비교하고 싶다. 그래서 최적의 장소만 선택하여 저장한다.

---

## 4. 유저 플로우(User Flow)

### 4-1. 정상 플로우: 링크 공유 → 일괄 분석 → 선택 저장

#### Phase 1: 링크 수집 (외부 앱)
1. **발견:** 사용자가 Instagram/블로그에서 관심 장소 발견
2. **공유:** iOS 공유 버튼 → "Hotly" 선택
3. **큐 추가:** Share Extension이 URL을 큐에 저장
4. **피드백:** "1개 링크 추가됨" 토스트 표시 (0.5초)
5. **복귀:** 즉시 원래 앱으로 복귀, 분석 대기 없음
6. **반복:** 2-5개 링크 반복 공유 (총 1-2분 소요)

#### Phase 2: 일괄 분석 (Hotly 앱)
7. **앱 실행:** 사용자가 Hotly 앱 실행
8. **감지:** 시스템이 대기 중인 링크 감지
9. **알림:** "3개 링크 분석 대기 중" 배지 표시
10. **시작:** 사용자가 "분석 시작" 버튼 클릭
11. **진행:** 바텀 시트에서 실시간 진행률 표시
    - 링크 1: ✅ 강남 카페 (완료)
    - 링크 2: 🔄 홍대 맛집 (분석 중...)
    - 링크 3: ⏳ 이태원 바 (대기 중)
12. **완료:** 모든 분석 완료 (약 1-2분)

#### Phase 3: 결과 확인 및 저장
13. **전환:** 결과 확인 화면으로 자동 이동
14. **검토:** 분석된 3개 장소 정보 확인
    - 신뢰도 점수 표시 (95%, 88%, 45%)
    - 장소명, 카테고리, 주소, 이미지 미리보기
15. **필터:** "신뢰도 높은 것만 저장" 옵션 제공
16. **선택:** 개별 장소마다 저장/편집/무시 선택
17. **저장:** 선택한 장소들 일괄 저장
18. **완료:** "2개 장소 저장됨" 확인 메시지

### 4-2. 에러 플로우

#### 분석 실패
- **원인:** 비공개 계정, 삭제된 게시물, 네트워크 오류
- **처리:**
  - 재시도 버튼 제공 (최대 3회)
  - 실패 이유 명시 ("비공개 계정")
  - 수동 입력 대안 제시

#### 잘못된 도메인
- **원인:** 지원하지 않는 플랫폼 (Facebook, Twitter 등)
- **처리:**
  - Share Extension에서 사전 필터링
  - "지원하지 않는 플랫폼" 알림
  - 큐에 추가하지 않음

#### 네트워크 단절
- **원인:** 오프라인 상태에서 분석 시도
- **처리:**
  - "네트워크 연결 필요" 안내
  - 대기열 유지, 자동 재시도 옵션
  - Wi-Fi 연결 시 자동 분석 제안

#### 배터리 부족
- **원인:** 배터리 20% 미만
- **처리:**
  - "저전력 모드 활성화됨" 알림
  - 분석 일시 중지 옵션
  - 충전 후 자동 재개 제안

### 4-3. 빈 상태 플로우
- **첫 사용:** 홈 화면에 "링크 공유로 장소 추가하기" 가이드 표시
- **큐 비어있음:** "공유된 링크가 없습니다" 상태 표시
- **분석 진행 중:** 진행률 바 + "2/5 분석 중..." 상태

---

## 5. 수용 기준(Acceptance Criteria)

| ID | 시나리오 | Given | When | Then |
|----|----------|-------|------|------|
| AC-01 | 빠른 공유 | 사용자가 Instagram에서 링크 공유 | Share Extension 활성화 | 0.5초 이내 큐 추가 완료, 토스트 표시 |
| AC-02 | 큐 저장 | 앱이 종료된 상태 | 여러 링크 공유 | 로컬 저장소에 안전하게 저장 |
| AC-03 | 앱 실행 감지 | 대기 중인 링크 존재 | Hotly 앱 실행 | 3초 이내 배지 표시 |
| AC-04 | 일괄 분석 시작 | 사용자가 분석 시작 클릭 | 큐에 3개 링크 | 순차적으로 분석 시작 |
| AC-05 | 진행률 표시 | 분석 진행 중 | 각 링크 분석 완료 시 | 실시간 상태 업데이트 (1초 이내) |
| AC-06 | 품질 우선 | 각 링크 분석 시 | AI 분석 수행 | 신뢰도 70% 이상 목표, 평균 20-30초 소요 |
| AC-07 | 결과 확인 | 모든 분석 완료 | 결과 화면 표시 | 신뢰도 점수와 함께 장소 정보 표시 |
| AC-08 | 필터링 | 신뢰도 낮은 결과 | 사용자가 필터 옵션 선택 | 70% 이상만 표시 |
| AC-09 | 재시도 | 분석 실패 항목 존재 | 재시도 버튼 클릭 | 실패 항목만 재분석 |
| AC-10 | 로컬 저장 | 큐에 항목 추가/변경 | 앱 종료/크래시 | 재실행 시 큐 상태 복원 |

---

## 6. 상충/의존성 점검(Conflict Matrix)

| 항목 | 잠재 충돌 | 정책/해결 |
|------|-----------|-----------|
| 즉시성 vs 품질 | 빠른 저장 vs 정확한 분석 | 공유는 즉시, 분석은 일괄 처리로 분리 |
| 배터리 vs 처리속도 | 빠른 분석 vs 배터리 소모 | 저전력 모드 자동 감지, Wi-Fi 권장 |
| 큐 크기 vs 메모리 | 무제한 저장 vs 메모리 제한 | 최대 20개 제한, 오래된 항목 자동 정리 |
| 자동 vs 수동 | 자동 분석 vs 사용자 제어 | 배지로 알림 후 수동 시작 (자동 옵션 제공) |
| 오프라인 vs 분석 | 네트워크 필요 vs 오프라인 사용 | 큐 저장은 오프라인 가능, 분석은 온라인 필수 |

---

## 7. 기술 요구사항(Technical Requirements)

### 7-1. iOS Share Extension
```swift
// 지원 플랫폼
- Instagram (instagram.com)
- 네이버 블로그 (blog.naver.com)
- 유튜브 (youtube.com, youtu.be)

// App Groups 설정
- group.com.hotly.sharequeue
- UserDefaults를 통한 데이터 공유

// 제약사항
- 최대 동시 공유: 5개
- URL 길이 제한: 2048자
- 메모리 제한: 30MB
```

### 7-2. 데이터 모델
```dart
class ShareQueueItem {
  String id;              // UUID
  String url;             // 원본 URL
  String? title;          // 페이지 제목 (선택)
  DateTime sharedAt;      // 공유 시각
  ShareQueueStatus status; // 상태
  PlaceAnalysisResult? result; // 분석 결과
  String? errorMessage;   // 에러 메시지
  int retryCount;         // 재시도 횟수
}

enum ShareQueueStatus {
  pending,    // 대기 중
  analyzing,  // 분석 중
  completed,  // 분석 완료
  saved,      // 저장됨
  failed,     // 실패
  ignored,    // 무시됨
}
```

### 7-3. 로컬 저장소
```dart
// SharedPreferences 사용
- 키: 'share_queue'
- 형식: JSON Array
- 최대 크기: 1MB (약 20개 항목)
- 자동 정리: 7일 경과 항목 삭제
```

### 7-4. Backend API
```python
# 기존 API 활용
POST /api/v1/link-analysis/analyze
{
  "url": "https://www.instagram.com/p/xxx"
}

# 응답
{
  "place_name": "장소명",
  "category": "카테고리",
  "address": "주소",
  "confidence": 0.95,
  "extracted_info": {...}
}
```

### 7-5. 성능 목표
| 메트릭 | 목표 | 측정 방법 |
|--------|------|-----------|
| 공유 완료 시간 | < 0.5초 | Share Extension 실행 → 토스트 표시 |
| 큐 로딩 시간 | < 1초 | 앱 실행 → 배지 표시 |
| 분석 시간 (링크당) | 20-30초 | API 호출 → 응답 수신 |
| 일괄 분석 (5개) | < 3분 | 전체 큐 처리 완료 |
| 메모리 사용량 | < 50MB | 분석 진행 중 피크 메모리 |

---

## 8. UI/UX 사양(UI/UX Specifications)

### 8-1. Share Extension UI
```
┌─────────────────────────────┐
│ 🔗 Hotly에 추가             │
│                             │
│ 📍 강남 맛집 카페           │
│ instagram.com/p/xxx         │
│                             │
│ ✅ 추가 완료!               │
└─────────────────────────────┘
- 디자인: 심플한 토스트 형태
- 표시 시간: 0.5초
- 애니메이션: 페이드 인/아웃
```

### 8-2. 홈 화면 배지
```
┌─────────────────────────────┐
│ 🏠 홈                       │
│                             │
│ ┌─────────────────────────┐ │
│ │ 🔗 3개 링크 분석 대기   │ │
│ │ [분석 시작]             │ │
│ └─────────────────────────┘ │
│                             │
│ 📍 저장된 장소              │
└─────────────────────────────┘
- 위치: 홈 화면 상단
- 색상: Primary 컬러
- 액션: 탭하면 분석 시작
```

### 8-3. 분석 진행 화면
```
┌─────────────────────────────┐
│ 📦 링크 분석 중 (2/3)       │
│ ━━━━━━━━━━░░░░░░ 66%        │
│                             │
│ ✅ 강남 카페                │
│    신뢰도 95%               │
│                             │
│ 🔄 홍대 맛집                │
│    분석 중...               │
│                             │
│ ⏳ 이태원 바                │
│    대기 중                  │
│                             │
│ [백그라운드로]              │
└─────────────────────────────┘
- 형태: 바텀 시트
- 진행률: 실시간 업데이트
- 상태 아이콘: 명확한 시각적 피드백
```

### 8-4. 결과 확인 화면
```
┌─────────────────────────────┐
│ ✨ 3개 장소 분석 완료        │
│                             │
│ [신뢰도 높은 것만] [모두]   │
│                             │
│ ┌─────────────────────────┐ │
│ │ 📷 [이미지]             │ │
│ │ 강남 카페               │ │
│ │ ⭐️ 95% │ 카페 │ 강남구 │ │
│ │ [저장] [편집] [무시]    │ │
│ └─────────────────────────┘ │
│                             │
│ ┌─────────────────────────┐ │
│ │ 📷 [이미지]             │ │
│ │ 홍대 맛집               │ │
│ │ ⭐️ 88% │ 식당 │ 마포구 │ │
│ │ [저장] [편집] [무시]    │ │
│ └─────────────────────────┘ │
│                             │
│ [2개 저장하기]              │
└─────────────────────────────┘
- 신뢰도 배지: 색상으로 구분
  - 90%+: 초록색
  - 70-89%: 노란색
  - 70% 미만: 빨간색
```

---

## 9. 구현 단계(Implementation Phases)

### Phase 1: 기본 인프라 (2일)
- [ ] Flutter 패키지 설치 (receive_sharing_intent)
- [ ] 데이터 모델 정의 (ShareQueueItem, State)
- [ ] 로컬 저장소 구현 (SharedPreferences)

### Phase 2: iOS Share Extension (3일)
- [ ] Xcode Share Extension target 생성
- [ ] Info.plist 설정 (도메인 필터)
- [ ] App Groups 설정 및 데이터 공유
- [ ] Swift 코드 구현 (URL 추출, 저장)

### Phase 3: Queue 관리 (3일)
- [ ] ShareQueueNotifier 구현
- [ ] 큐 추가/제거/상태 관리
- [ ] Batch Processor 로직
- [ ] 에러 핸들링 및 재시도

### Phase 4: UI 구현 (4일)
- [ ] 홈 화면 배지 위젯
- [ ] 분석 진행 바텀 시트
- [ ] 결과 확인 화면
- [ ] 신뢰도 필터링 UI

### Phase 5: 테스트 & 최적화 (3일)
- [ ] E2E 테스트 (실제 링크)
- [ ] 성능 테스트 (배터리, 메모리)
- [ ] 오프라인 시나리오 테스트
- [ ] UX 개선 (애니메이션, 피드백)

**총 예상 기간:** 15일

---

## 10. 성공 지표(Success Metrics)

### 10-1. 사용성 지표
| 메트릭 | 목표 | 측정 방법 |
|--------|------|-----------|
| 공유 완료율 | > 95% | 공유 시도 대비 큐 추가 성공 |
| 평균 공유 개수 | 3-5개 | 세션당 공유된 링크 수 |
| 분석 시작율 | > 80% | 큐 생성 대비 분석 시작 |
| 저장 전환율 | > 60% | 분석 완료 대비 저장 |

### 10-2. 품질 지표
| 메트릭 | 목표 | 측정 방법 |
|--------|------|-----------|
| 분석 성공률 | > 85% | 총 분석 대비 완료 |
| 평균 신뢰도 | > 80% | 분석 결과 신뢰도 평균 |
| 재분석율 | < 10% | 실패 후 재시도 비율 |
| 수동 수정율 | < 20% | 결과 편집 비율 |

### 10-3. 성능 지표
| 메트릭 | 목표 | 측정 방법 |
|--------|------|-----------|
| 공유 응답 시간 | < 0.5초 | Share Extension 실행 시간 |
| 평균 분석 시간 | 20-30초 | 링크당 분석 소요 시간 |
| 배터리 사용량 | < 5% | 5개 링크 분석 시 배터리 소모 |
| 크래시율 | < 0.1% | 앱 크래시 비율 |

---

## 11. 릴리스 기준(Release Criteria)

### 필수 조건
- [ ] AC-01 ~ AC-10 모두 통과
- [ ] iOS 공유 시트에서 Hotly 선택 가능
- [ ] 3개 이상 링크 일괄 분석 성공
- [ ] 신뢰도 점수 정확히 표시
- [ ] 오프라인 → 온라인 전환 시 자동 재개

### 권장 조건
- [ ] 배터리 절약 모드 지원
- [ ] 백그라운드 분석 옵션
- [ ] 분석 결과 캐싱
- [ ] 재시도 로직 (최대 3회)

### 성능 기준
- [ ] 공유 완료 < 0.5초
- [ ] 분석 시작 < 3초
- [ ] 메모리 사용 < 50MB
- [ ] 크래시율 < 0.1%

---

## 12. 향후 확장(Future Enhancements)

### v1.1 - 자동화
- 자동 분석 옵션 (Wi-Fi 연결 시)
- 스마트 알림 (귀가 시간 감지)
- 백그라운드 분석 (앱 미실행 상태)

### v1.2 - 고급 기능
- 중복 링크 자동 감지
- 유사 장소 병합 제안
- 카테고리별 자동 분류

### v1.3 - 소셜 기능
- 친구에게 큐 공유
- 협업 위시리스트
- 추천 장소 공유

---

## 13. 참고 자료(References)

### 관련 PRD
- [01-sns-link-analysis.md](./01-sns-link-analysis.md) - SNS 링크 분석 기본 기능
- [02-place-management.md](./02-place-management.md) - 장소 관리 시스템
- [09-authentication.md](./09-authentication.md) - 사용자 인증 (App Groups 연동)

### 기술 문서
- [iOS Share Extension Documentation](https://developer.apple.com/documentation/uikit/share_extension)
- [App Groups Guide](https://developer.apple.com/documentation/bundleresources/entitlements/com_apple_security_application-groups)
- [receive_sharing_intent Package](https://pub.dev/packages/receive_sharing_intent)

### 디자인 레퍼런스
- Pinterest - 링크 저장 플로우
- Pocket - 일괄 처리 UI
- Instapaper - 분석 진행 표시

---

**버전:** v1.0
**작성일:** 2025-11-26
**작성자:** Claude Code
**상태:** 설계 완료
