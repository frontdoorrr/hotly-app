# PRD: Firebase Authentication 기반 인증

## 1. 기능 개요
**핵심 가치:** Firebase Authentication을 활용하여 안전하고 편리한 회원가입/로그인 경험을 제공하며, 소셜 로그인과 게스트 모드를 통해 사용자 진입 장벽을 최소화한다.

**사용자 이점:** 복잡한 회원가입 절차 없이 기존 소셜 계정으로 3초 내 로그인하여 바로 앱의 핵심 기능을 사용할 수 있다.

---

## 2. 페르소나(Persona)
**주 사용자:** 윤서(22세, 대학생)
- **맥락:** 새로운 앱마다 회원가입하는 것이 번거롭고, 복잡한 비밀번호 설정과 이메일 인증이 귀찮음
- **목표:** 가장 빠르고 간편한 방법으로 앱에 가입해서 친구들과 데이트 계획 공유하고 싶음
- **동기:** 데이트 앱은 개인정보가 중요하니까 안전하면서도 편리한 로그인 방식 선호
- **제약:** 복잡한 절차나 개인정보 과다 요구 시 앱 삭제, 소셜 로그인 선호
- **성공 정의:** 3번의 터치로 로그인 완료, 개인정보 최소 입력, 안전한 데이터 보호

**핵심 Pain Points:**
1. **회원가입 피로감:** 매번 새로운 ID/PW 생성하고 이메일 인증하는 번거로움
2. **개인정보 우려:** 데이트 관련 앱에 민감한 개인정보 입력 부담
3. **접근성 장벽:** 로그인하지 않으면 아무것도 할 수 없어서 앱 체험 불가

---

## 3. 유저 스토리(User Stories)
- **간편 가입자**로서, 구글/애플 계정으로 원클릭 로그인하고 싶다. 그래서 복잡한 회원가입 절차를 생략한다.
- **체험 사용자**로서, 로그인 없이도 기본 기능을 체험하고 싶다. 그래서 앱의 가치를 먼저 확인한 후 가입을 결정한다.
- **보안 중시자**로서, 내 데이트 계획과 위시리스트가 안전하게 보호되길 원한다. 그래서 신뢰할 수 있는 인증 시스템을 사용한다.
- **연동 추구자**로서, 여러 기기에서 동일한 계정으로 데이터를 동기화하고 싶다. 그래서 어디서든 내 정보에 접근한다.
- **카카오 사용자**로서, 한국에서 가장 많이 쓰는 카카오 계정으로 로그인하고 싶다. 그래서 친숙한 방법으로 빠르게 가입한다.

---

## 4. 유저 플로우(User Flow)

### 4-1. 소셜 로그인 플로우
1. **로그인 화면:** "구글로 계속하기", "애플로 계속하기", "카카오로 계속하기" 버튼 표시
2. **소셜 인증:** 선택한 플랫폼의 OAuth 인증 실행 (팝업 또는 리다이렉트)
3. **권한 동의:** 기본 프로필 정보(이름, 이메일) 접근 권한 동의
4. **자동 로그인:** Firebase가 자동으로 계정 생성 또는 로그인 처리
5. **메인 화면 진입:** 즉시 앱 사용 가능

### 4-2. 이메일 회원가입 플로우
1. **이메일 입력:** "이메일로 계속하기" 선택 후 이메일 주소 입력
2. **비밀번호 설정:** 6자 이상 비밀번호 생성
3. **회원가입 완료:** Firebase Authentication에 계정 생성
4. **프로필 설정:** 닉네임 입력 (선택사항)
5. **메인 화면 진입:** 앱 사용 시작

### 4-3. 게스트 모드 플로우
1. **게스트 진입:** "로그인 없이 둘러보기" 선택
2. **익명 로그인:** Firebase Anonymous Authentication으로 임시 UID 발급
3. **기능 체험:** 장소 저장, 코스 생성 등 기본 기능 체험
4. **가입 유도:** 체험 중 주요 시점에서 "가입하고 저장하기" 제안
5. **계정 연결:** 소셜 로그인으로 업그레이드 시 데이터 자동 이전

### 4-4. 카카오 로그인 플로우 (한국 특화)
1. **카카오 로그인 시작:** "카카오로 계속하기" 버튼 클릭
2. **카카오 SDK 인증:** 카카오톡 앱 또는 웹으로 로그인
3. **액세스 토큰 획득:** 카카오 OAuth 토큰 받기
4. **백엔드 토큰 교환:** 카카오 토큰을 Firebase Custom Token으로 변환
5. **Firebase 로그인:** Custom Token으로 Firebase 인증 완료
6. **메인 화면 진입:** 앱 사용 시작

### 4-5. 로그인 유지 및 보안 플로우
1. **자동 로그인:** 앱 재실행 시 Firebase 세션 자동 유지
2. **토큰 갱신:** Firebase ID Token 자동 갱신 (1시간마다)
3. **보안 검증:** 민감한 작업 시 재인증 요구 (계정 삭제 등)
4. **로그아웃:** 사용자 요청 또는 보안 이벤트 시 안전한 로그아웃
5. **다중 기기:** 여러 기기에서 동일 계정 동시 사용 지원

---

## 5. 수용 기준(Acceptance Criteria)

| ID | 시나리오 | Given | When | Then |
|----|----------|-------|------|------|
| AC-01 | 소셜 로그인 속도 | 구글/애플/카카오 앱 설치됨 | 소셜 로그인 버튼 클릭 | 5초 이내 인증 완료 및 앱 진입 |
| AC-02 | 게스트 모드 진입 | 신규 앱 설치 | "둘러보기" 선택 | 즉시 메인 화면 진입, 익명 UID 발급 |
| AC-03 | 자동 로그인 | 이전에 로그인한 계정 | 앱 재실행 시 | 별도 로그인 없이 바로 메인 화면 |
| AC-04 | 게스트 데이터 이전 | 게스트 모드에서 데이터 생성 | 소셜 로그인으로 업그레이드 | 게스트 데이터가 계정으로 자동 이전 |
| AC-05 | 카카오 로그인 | 카카오톡 앱 설치됨 | "카카오로 계속하기" 클릭 | 카카오톡 앱으로 인증 후 5초 내 Firebase 로그인 |
| AC-06 | 토큰 자동 갱신 | 앱 사용 중 1시간 경과 | Firebase ID Token 만료 | 자동으로 새 토큰 발급, 사용자 인지 불가 |
| AC-07 | 계정 삭제 | 로그인된 상태 | 회원 탈퇴 요청 | Firebase 계정 삭제 및 모든 데이터 삭제 |

---

## 6. 상충/의존성 점검(Conflict Matrix)

| 항목 | 잠재 충돌 | 정책/해결 |
|------|-----------|-----------|
| 편의성 vs 보안 | 자동 로그인 vs 계정 보안 | Firebase 세션 관리 + 민감 작업 시 재인증 |
| 게스트 vs 가입 | 무료 체험 vs 가입 유도 | 핵심 기능 체험 후 고도화 기능에서 가입 유도 |
| 소셜 vs 이메일 | 간편함 vs 의존성 | 소셜 우선 권장, 이메일은 대안으로 제공 |
| 카카오 vs 글로벌 | 한국 시장 vs 글로벌 확장 | 카카오는 한국 최적화, 글로벌은 Google/Apple |
| 개인정보 최소화 vs 개인화 | 정보 수집 vs 맞춤 서비스 | 필수 최소 정보만 수집, 부가 정보는 선택적 제공 |

---

## 7. 기능별 상세 명세

### 7-1. 지원 인증 방식
```
소셜 로그인 (우선 순위):
├── 🎯 구글 (Google Sign-In) - 글로벌 표준
├── 🍎 애플 (Sign in with Apple) - iOS 필수
├── 💬 카카오 (Kakao Login) - 한국 시장 필수
└── 📧 이메일 (Firebase Email/Password) - 백업 옵션

부가 방식:
├── 👤 게스트 모드 (Firebase Anonymous Auth)
└── 🔗 계정 연결 (Anonymous → Social)
```

### 7-2. 사용자 정보 스키마
```json
{
  "uid": "string (Firebase UID)",
  "email": "string | null",
  "displayName": "string | null",
  "photoURL": "string | null",
  "providerId": "google.com | apple.com | password | anonymous",
  "isAnonymous": "boolean",
  "emailVerified": "boolean",
  "metadata": {
    "creationTime": "timestamp",
    "lastSignInTime": "timestamp"
  },
  "customClaims": {
    "role": "user | admin",
    "nickname": "string",
    "preferences": {}
  }
}
```

### 7-3. 권한 및 제한사항
```
게스트 모드 제한:
✅ 허용: 장소 저장, 코스 생성, 지도 보기 (Firebase UID 기반)
❌ 제한: 코스 공유, 알림, 다중 기기 동기화, 커뮤니티

로그인 후 추가 기능:
✅ 다중 기기 동기화 (Firebase Auth 세션)
✅ 코스 공유 및 협업 (UID 기반)
✅ 알림 및 리마인더 (FCM 연동)
✅ 개인화 추천 (프로필 데이터 활용)
✅ 사용 통계 및 히스토리
```

### 7-4. 보안 정책
```
비밀번호 정책 (이메일 로그인):
- 최소 6자 (Firebase 기본 정책)
- 권장: 영문 + 숫자 조합

세션 관리:
- ID Token 유효기간: 1시간 (Firebase 자동 관리)
- Refresh Token: 영구 (기기별)
- 다중 기기: 무제한 동시 로그인
- 의심 활동 감지 시 백엔드에서 세션 무효화
```

---

## 8. KPI / 측정 지표

### 8-1. 가입 및 로그인
- **가입 전환율:** 앱 설치 → 회원가입 완료 ≥ 40%
- **소셜 로그인 비율:** 전체 가입 중 소셜 로그인 ≥ 80% (카카오 포함)
- **카카오 로그인 비율:** 한국 사용자 중 카카오 로그인 ≥ 60%
- **게스트 전환율:** 게스트 → 회원가입 전환 ≥ 25%

### 8-2. 사용자 유지
- **로그인 성공률:** 로그인 시도 → 성공 ≥ 95%
- **자동 로그인률:** 앱 재실행 시 자동 로그인 성공 ≥ 95%
- **계정 유지율:** 가입 후 30일 활성 사용자 비율 ≥ 60%

### 8-3. 보안 및 신뢰
- **토큰 갱신 성공률:** 자동 토큰 갱신 성공 ≥ 99%
- **계정 복구 성공률:** 비밀번호 찾기 → 복구 완료 ≥ 85%
- **보안 사고:** 계정 해킹/도용 사고 0건

---

## 9. UI/UX 가이드라인

### 9-1. 로그인 화면
```
┌─────────────────────────┐
│                         │
│      🎯 Hotly           │
│   데이트 코스 플래너      │
│                         │
│ [🎯 구글로 계속하기]      │
│ [🍎 애플로 계속하기]      │
│ [💬 카카오로 계속하기]     │
│                         │
│ [이메일로 가입하기]       │
│                         │
│ 로그인 없이 둘러보기      │
└─────────────────────────┘
```

### 9-2. 이메일 가입 폼
```
┌─────────────────────────┐
│ ← 이메일로 가입          │
├─────────────────────────┤
│ 이메일 주소              │
│ [example@email.com  ]   │
│                         │
│ 비밀번호                │
│ [•••••••••••••••••• ] 👁 │
│ 6자 이상                │
│                         │
│ 닉네임 (선택)           │
│ [홍길동             ]   │
│                         │
│ [가입하기]              │
└─────────────────────────┘
```

### 9-3. 게스트 모드 안내
```
┌─────────────────────────┐
│ 👋 게스트로 둘러보는 중  │
├─────────────────────────┤
│ 현재 사용 가능:          │
│ ✅ 장소 저장 (기기 내)    │
│ ✅ 코스 만들기           │
│ ✅ 지도 보기            │
│                         │
│ 가입하면 추가로:         │
│ 🚀 다중 기기 동기화      │
│ 🚀 친구와 코스 공유      │
│ 🚀 맞춤 추천            │
│                         │
│ [지금 가입하기]         │
│ [나중에 하기]           │
└─────────────────────────┘
```

### 9-4. 카카오 로그인 버튼
```
┌─────────────────────────┐
│                         │
│  [💬 카카오로 계속하기]  │
│   Kakao 공식 디자인      │
│   배경: #FEE500         │
│   텍스트: #000000       │
│                         │
└─────────────────────────┘
```

---

## 10. 접근성 / 국제화

### 10-1. 접근성
- **스크린리더:** 로그인 방식별 설명 음성 제공 ("구글 계정으로 로그인")
- **키보드 탐색:** Tab 키로 모든 로그인 옵션 접근 가능
- **고대비:** 로그인 버튼과 배경 명확한 대비 (WCAG AA 이상)
- **터치:** 로그인 버튼 최소 48dp 높이

### 10-2. 국제화
- **다국어:** 한국어/영어 로그인 화면
- **지역 최적화:** 한국에서는 카카오 우선 표시, 해외에서는 Google 우선
- **약관:** 서비스 지역별 법적 요구사항 반영
- **에러 메시지:** 현지화된 오류 안내

---

## 11. Firebase 연동 상세

### 11-1. Firebase 프로젝트 설정
```
Authentication 제공업체 활성화:
├── Email/Password ✅
├── Google ✅
├── Apple ✅ (iOS)
└── Anonymous ✅ (게스트)

Kakao 연동:
├── Kakao SDK로 로그인
├── 백엔드에서 Custom Token 생성
└── Firebase signInWithCustomToken 사용
```

### 11-2. 토큰 관리
```dart
// Flutter에서 ID Token 가져오기
final idToken = await FirebaseAuth.instance.currentUser?.getIdToken();

// API 호출 시 헤더에 포함
headers: {
  'Authorization': 'Bearer $idToken',
}

// 토큰 자동 갱신 (Firebase SDK가 자동 처리)
FirebaseAuth.instance.idTokenChanges().listen((user) {
  // 새 토큰 발급 시 자동 업데이트
});
```

### 11-3. 오프라인 지원
- **로컬 세션:** Firebase Auth SDK가 자동으로 세션 관리
- **오프라인 인증:** 캐시된 세션으로 임시 인증
- **자동 동기화:** 온라인 복귀 시 세션 검증 및 갱신

---

## 12. 보안 강화

### 12-1. Firebase 보안 규칙
```javascript
// Firestore Security Rules
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 사용자는 자신의 데이터만 접근
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // 게스트는 자신의 익명 데이터만 접근
    match /guest_data/{guestId} {
      allow read, write: if request.auth != null && request.auth.uid == guestId;
    }
  }
}
```

### 12-2. 추가 보안 기능
```
백엔드 검증:
├── Firebase Admin SDK로 ID Token 검증
├── Custom Claims로 역할 관리 (user, admin)
├── Rate Limiting (로그인 시도 제한)
└── 이상 행동 감지 (새로운 기기, 지역 변경)

클라이언트 보안:
├── Firebase SDK 자동 토큰 갱신
├── Secure Storage에 민감 정보 저장
└── HTTPS/TLS 1.3 통신
```

### 12-3. 데이터 보호
- **전송 암호화:** HTTPS/TLS 1.3
- **저장 암호화:** Firebase 자동 암호화
- **개인정보 마스킹:** 로그에서 이메일/UID 마스킹
- **GDPR 준수:** EU 사용자 데이터 보호 규정 준수

---

## 13. 에러 처리

### 13-1. 일반적인 에러 상황
```
Firebase Auth 에러:
├── user-not-found: "등록되지 않은 이메일입니다"
├── wrong-password: "비밀번호가 일치하지 않습니다"
├── email-already-in-use: "이미 사용 중인 이메일입니다"
├── weak-password: "비밀번호가 너무 약합니다 (최소 6자)"
├── network-request-failed: "네트워크 연결을 확인해주세요"
└── too-many-requests: "로그인 시도 횟수를 초과했습니다"

소셜 로그인 실패:
├── popup-closed-by-user: "로그인이 취소되었습니다"
├── account-exists-with-different-credential: "다른 로그인 방법으로 이미 가입된 계정입니다"
└── credential-already-in-use: "이미 다른 계정에 연결된 인증 정보입니다"

카카오 로그인 실패:
├── Kakao SDK 에러: "카카오 로그인에 실패했습니다"
├── Custom Token 에러: "인증 서버 연결에 실패했습니다"
└── Firebase 로그인 에러: "계정 생성에 실패했습니다"
```

### 13-2. 사용자 친화적 에러 메시지
```
"이메일 또는 비밀번호가 잘못되었어요"
→ [비밀번호 찾기] 버튼 제공

"네트워크 연결을 확인해주세요"
→ [다시 시도] 버튼 + 오프라인 모드 안내

"잠시 후 다시 시도해주세요"
→ 서버 오류 시 자동 재시도 + 예상 복구 시간

"다른 로그인 방법으로 이미 가입된 계정입니다"
→ 기존 로그인 방법 안내 + 계정 연결 제안
```

---

## 14. 용어 사전(Glossary)
- **Firebase Authentication:** Google의 백엔드 인증 서비스 플랫폼
- **OAuth:** 소셜 로그인에 사용되는 개방형 인증 표준
- **ID Token:** Firebase 사용자를 인증하는 JWT 토큰 (1시간 유효)
- **Refresh Token:** ID Token 갱신에 사용되는 장기 토큰
- **Anonymous Auth:** Firebase의 익명 인증 기능 (게스트 모드)
- **Custom Token:** 백엔드에서 생성하는 Firebase 로그인 토큰 (Kakao 연동)
- **Custom Claims:** Firebase 사용자 메타데이터 (역할, 권한 등)

---

## 15. 기술 제약
- **Firebase 제한:**
  - Spark 플랜: 월 50,000명 활성 사용자
  - Blaze 플랜: 사용량 기반 과금 ($0.0055/verification)
- **소셜 로그인:** 플랫폼별 API 제한 및 정책 변경 위험
- **토큰 크기:** Firebase ID Token 최대 1000 claims (Custom Claims 제한)
- **오프라인:** 네트워크 없이는 신규 가입/로그인 불가 (기존 세션은 유지)
- **Kakao 의존성:** Custom Token 방식으로 백엔드 필수

---

## 16. 카카오 로그인 특화 기능

### 16-1. 카카오 로그인 장점
- **한국 시장 점유율:** 95% 이상 사용자 보유
- **빠른 인증:** 카카오톡 앱으로 1-2초 내 인증
- **친숙한 UX:** 한국 사용자에게 가장 익숙한 로그인 방법
- **추가 정보:** 프로필 사진, 닉네임 기본 제공

### 16-2. 카카오 통합 플로우
```
[카카오 로그인 버튼]
    ↓
[Kakao SDK 인증]
├── 카카오톡 설치됨 → 카카오톡 앱 인증 (1-2초)
└── 미설치 → 카카오 웹 인증 (3-5초)
    ↓
[카카오 액세스 토큰 획득]
    ↓
[백엔드 API 호출]
POST /api/v1/auth/social-login
{
  "provider": "kakao",
  "accessToken": "kakao_access_token"
}
    ↓
[백엔드: Firebase Custom Token 생성]
    ↓
[앱: Firebase signInWithCustomToken]
    ↓
[Firebase 로그인 완료]
```

---

## Changelog
- 2025-01-XX: 초기 문서 작성 - Firebase 기반 (작성자: Claude)
- 2025-01-XX: Firebase Authentication 기반으로 완전 재작성 (작성자: Claude)
  - 실제 구현 코드 반영
  - 카카오 로그인 플로우 추가
  - Firebase 특화 기능 및 제약사항 명시
