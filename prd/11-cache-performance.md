# PRD: 캐시 전략 및 성능 최적화

## 1. 기능 개요
**핵심 가치:** 사용자가 느끼는 앱의 속도와 반응성을 극대화하기 위해 전략적 캐싱과 성능 최적화를 통해 로딩 시간을 최소화하고 오프라인 상황에서도 핵심 기능을 제공한다.

**사용자 이점:** 느린 네트워크나 오프라인 상황에서도 끊김 없는 사용 경험을 제공하며, 데이터 사용량을 절약하고 배터리 수명을 연장한다.

---

## 2. 페르소나(Persona)
**주 사용자:** 지훈(26세, 직장인)
- **맥락:** 지하철 통근 중에 자주 앱을 사용하지만 신호가 약하거나 끊어지는 구간이 많아 답답함
- **목표:** 네트워크 상태와 관계없이 빠르고 부드럽게 앱을 사용하며, 데이터 요금 걱정 없이 이용하고 싶음
- **동기:** 점심시간이나 이동 중 짧은 시간에도 효율적으로 데이트 계획을 세우고 싶음
- **제약:** 무제한 데이터가 아니어서 데이터 사용량에 민감하고, 배터리 소모도 신경 쓰임
- **성공 정의:** 3초 내 화면 로딩, 오프라인에서도 기본 기능 사용 가능, 월 데이터 사용량 100MB 이하

**핵심 Pain Points:**
1. **로딩 지연:** 새 화면으로 이동할 때마다 몇 초씩 기다려야 하는 답답함
2. **네트워크 단절:** 지하철, 엘리베이터에서 인터넷 끊김으로 인한 사용 불가
3. **데이터 소모:** 이미지와 지도 로딩으로 인한 과도한 데이터 사용량

---

## 3. 유저 스토리(User Stories)
- **빠른 접근자**로서, 자주 보는 위시리스트와 코스가 즉시 로딩되길 원한다. 그래서 매번 기다리지 않고 바로 확인한다.
- **모바일 사용자**로서, 이미지와 지도가 빠르게 로딩되면서도 데이터를 적게 사용하길 원한다. 그래서 요금 부담 없이 자유롭게 탐색한다.
- **오프라인 사용자**로서, 네트워크가 없어도 저장된 장소와 코스를 볼 수 있길 원한다. 그래서 어디서든 계획을 검토할 수 있다.
- **효율성 추구자**로서, 배터리 소모를 최소화하면서도 부드러운 사용 경험을 원한다. 그래서 하루 종일 앱을 사용할 수 있다.

---

## 4. 유저 플로우(User Flow)

### 4-1. 초기 앱 로딩 최적화 플로우
1. **스플래시 화면:** 필수 데이터만 미리 로딩하는 동안 브랜딩 표시
2. **캐시 우선 로딩:** 로컬 캐시에서 이전 데이터 먼저 표시
3. **백그라운드 업데이트:** 사용자가 보는 동안 최신 데이터 백그라운드 동기화
4. **점진적 로딩:** 화면에 보이는 부분부터 우선 로딩, 스크롤 시 추가 로딩
5. **업데이트 알림:** 새로운 데이터 로딩 완료 시 사용자에게 알림

### 4-2. 이미지 최적화 플로우
1. **지연 로딩:** 화면에 보이는 이미지만 로딩, 스크롤 시 추가 로딩
2. **해상도 적응:** 기기별 최적 해상도로 이미지 제공 (1x, 2x, 3x)
3. **WebP 변환:** 지원 기기에서는 WebP 포맷으로 용량 50% 절약
4. **캐시 저장:** 한 번 로딩한 이미지는 로컬 캐시에 7일간 보관
5. **CDN 활용:** 전 세계 CDN으로 빠른 이미지 전송

### 4-3. 오프라인 지원 플로우
1. **핵심 데이터 캐싱:** 위시리스트, 최근 코스를 로컬 DB에 저장
2. **오프라인 감지:** 네트워크 상태 모니터링하여 오프라인 모드 자동 전환
3. **제한 기능 안내:** 오프라인에서 사용 가능한 기능과 제한사항 표시
4. **동기화 대기:** 오프라인 중 변경사항을 로컬에 저장, 온라인 시 자동 동기화
5. **충돌 해결:** 온라인 복귀 시 로컬-서버 데이터 충돌 감지 및 해결

### 4-4. 메모리 및 저장소 관리 플로우
1. **사용량 모니터링:** 캐시 크기와 메모리 사용량 실시간 추적
2. **자동 정리:** 설정된 임계값 초과 시 오래된 캐시 자동 삭제
3. **우선순위 관리:** 자주 사용하는 데이터는 보존, 드물게 사용하는 것 먼저 삭제
4. **사용자 제어:** 설정에서 캐시 크기 조절 및 수동 정리 옵션 제공
5. **저장공간 알림:** 기기 저장공간 부족 시 캐시 정리 제안

---

## 5. 수용 기준(Acceptance Criteria)

| ID | 시나리오 | Given | When | Then |
|----|----------|-------|------|------|
| AC-01 | 초기 로딩 속도 | 앱 실행 | 첫 화면 진입 시 | 3초 이내 캐시된 데이터로 화면 표시 |
| AC-02 | 이미지 로딩 최적화 | 장소 리스트 화면 | 이미지가 많은 화면 진입 | 화면 표시 1초, 이미지 로딩 5초 이내 완료 |
| AC-03 | 오프라인 기능 | 네트워크 연결 끊김 | 위시리스트 접근 시 | 캐시된 데이터로 정상 표시 및 오프라인 안내 |
| AC-04 | 캐시 효율성 | 동일한 데이터 재요청 | 이미 로딩한 장소 재방문 | 캐시에서 즉시 로딩, 네트워크 요청 없음 |
| AC-05 | 메모리 관리 | 장시간 앱 사용 | 1시간 이상 연속 사용 | 메모리 사용량 200MB 이하 유지 |
| AC-06 | 배터리 최적화 | 백그라운드 동기화 | 앱이 백그라운드 상태 | 배터리 소모 시간당 2% 이하 |
| AC-07 | 데이터 사용량 | 한 달간 일반적 사용 | 월 20시간 사용 기준 | 총 데이터 사용량 100MB 이하 |

---

## 6. 상충/의존성 점검(Conflict Matrix)

| 항목 | 잠재 충돌 | 정책/해결 |
|------|-----------|-----------|
| 캐시 크기 vs 저장공간 | 많은 캐시 vs 기기 용량 부족 | 기본 500MB 제한, 사용자 설정으로 조절 가능 |
| 최신성 vs 속도 | 실시간 데이터 vs 빠른 로딩 | 캐시 우선 표시 후 백그라운드 업데이트 |
| 품질 vs 용량 | 고해상도 이미지 vs 데이터 절약 | 기기별/네트워크별 적응형 해상도 |
| 오프라인 vs 동기화 | 로컬 변경 vs 서버 충돌 | 타임스탬프 기반 충돌 감지 및 사용자 선택 |

---

## 7. 기능별 상세 명세

### 7-1. 캐시 계층 구조
```
L1 - 메모리 캐시 (RAM):
├── 현재 화면 데이터 (50MB)
├── 자주 사용하는 이미지 (100MB)
└── 사용자 세션 정보 (10MB)

L2 - 디스크 캐시 (Storage):
├── 장소/코스 상세 정보 (200MB)
├── 이미지 파일 (300MB)
├── 지도 타일 (100MB)
└── 검색 결과 (50MB)

L3 - SQLite 로컬 DB:
├── 위시리스트 (오프라인 필수)
├── 사용자 설정
├── 캐시 메타데이터
└── 동기화 큐
```

### 7-2. 캐시 정책
```
TTL (Time To Live):
├── 장소 기본정보: 7일
├── 영업시간/리뷰: 1일
├── 이미지: 30일
├── 지도 타일: 14일
└── 검색 결과: 1시간

LRU (Least Recently Used):
- 메모리/디스크 한계 도달 시 적용
- 접근 시간 기준으로 오래된 것부터 삭제
- 사용자 즐겨찾기는 삭제 우선순위 최하위
```

### 7-3. 네트워크 최적화
```
요청 최적화:
├── 배치 요청: 여러 데이터를 하나의 API로 묶어서 요청
├── 압축: gzip/brotli 압축으로 전송 용량 50% 절약
├── HTTP/2: 다중 요청 동시 처리
└── CDN: 전 세계 엣지 서버로 빠른 응답

응답 최적화:
├── 페이지네이션: 20개씩 나누어 로딩
├── 필드 선택: 필요한 데이터만 요청 (GraphQL 스타일)
├── 조건부 요청: ETag/Last-Modified 헤더로 변경사항만 전송
└── 우선순위 큐: 중요한 요청부터 우선 처리
```

### 7-4. 성능 모니터링
```json
{
  "metrics": {
    "loadTime": {
      "appStart": "number (ms)",
      "firstScreen": "number (ms)",
      "imageComplete": "number (ms)"
    },
    "cacheHitRate": {
      "memory": "number (0-1)",
      "disk": "number (0-1)",
      "overall": "number (0-1)"
    },
    "networkUsage": {
      "session": "number (bytes)",
      "daily": "number (bytes)",
      "monthly": "number (bytes)"
    },
    "memoryUsage": {
      "current": "number (MB)",
      "peak": "number (MB)",
      "average": "number (MB)"
    }
  }
}
```

---

## 8. KPI / 측정 지표

### 8-1. 로딩 성능
- **앱 시작 시간:** 콜드 스타트 3초 이내, 웜 스타트 1초 이내
- **화면 전환 속도:** 평균 1.5초 이내 새 화면 표시
- **이미지 로딩:** First Paint 1초, Complete Load 5초 이내

### 8-2. 캐시 효율성
- **캐시 적중률:** 전체 요청의 70% 이상 캐시에서 처리
- **데이터 절약률:** 캐시 활용으로 네트워크 사용량 50% 절약
- **오프라인 사용률:** 네트워크 없이도 기본 기능 90% 사용 가능

### 8-3. 리소스 효율성
- **메모리 사용량:** 일반 사용 시 200MB 이하 유지
- **저장공간:** 캐시 기본값 500MB, 최대 2GB 제한
- **배터리 소모:** 시간당 3% 이하 (백그라운드 포함)

---

## 9. 기술 구현

### 9-1. 캐시 라이브러리
```
Flutter/Dart:
├── dio_cache_interceptor (HTTP 캐시)
├── cached_network_image (이미지 캐시)
├── sqflite (로컬 데이터베이스)
└── connectivity_plus (네트워크 상태)

iOS:
├── NSURLCache (HTTP 캐시)
├── SDWebImage (이미지 캐시)
├── Core Data (로컬 저장)
└── Reachability (네트워크 감지)

Android:
├── OkHttp Cache (HTTP 캐시)
├── Glide (이미지 캐시)
├── Room Database (로컬 저장)
└── ConnectivityManager (네트워크 상태)
```

### 9-2. 캐시 키 전략
```
키 네이밍 규칙:
hotly:{version}:{type}:{id}:{params_hash}

예시:
- hotly:v1:place:12345:a1b2c3 (장소 상세 정보)
- hotly:v1:image:thumbnail:67890:d4e5f6 (썸네일 이미지)
- hotly:v1:course:user123:route:g7h8i9 (사용자 코스)

버전 관리:
- API 스키마 변경 시 version 증가
- 하위 호환성 유지를 위한 점진적 업그레이드
```

### 9-3. 오프라인 동기화
```javascript
// 오프라인 변경사항 큐
const offlineQueue = {
  actions: [
    {
      type: 'ADD_PLACE',
      data: {...},
      timestamp: 1640995200000,
      retry: 0
    }
  ]
};

// 온라인 복귀 시 동기화
function syncOfflineActions() {
  offlineQueue.actions.forEach(async (action) => {
    try {
      await apiCall(action);
      removeFromQueue(action);
    } catch (error) {
      action.retry++;
      if (action.retry > 3) {
        markAsConflict(action);
      }
    }
  });
}
```

---

## 10. 사용자 설정 옵션

### 10-1. 캐시 관리 설정
```
⚙️ 성능 설정
├── 💾 캐시 크기
│   ├── 절약 모드 (200MB)
│   ├── 기본 (500MB) ✓
│   ├── 고성능 (1GB)
│   └── 사용자 정의
├── 📱 데이터 절약
│   ├── WiFi만 고화질 이미지 ✓
│   ├── 이미지 품질 자동 조절 ✓
│   └── 백그라운드 동기화 제한
├── 🔄 동기화 설정
│   ├── 실시간 동기화 ✓
│   ├── WiFi에서만 동기화
│   └── 수동 동기화
└── 🗑️ 캐시 관리
    ├── 캐시 정리 (15.3GB → 삭제)
    ├── 이미지만 정리
    └── 자동 정리 설정
```

### 10-2. 성능 모드
```
성능 프로필:
├── 🔋 배터리 절약 모드
│   ├── 백그라운드 동기화 최소화
│   ├── 애니메이션 단순화
│   └── 이미지 품질 낮춤
├── ⚡ 고성능 모드
│   ├── 적극적 프리로딩
│   ├── 고해상도 이미지
│   └── 부드러운 애니메이션
└── 🌐 오프라인 우선 모드
    ├── 최대 캐시 활용
    ├── 필수 데이터 미리 다운로드
    └── 오프라인 기능 강화
```

---

## 11. 모니터링 및 분석

### 11-1. 성능 대시보드
```
📊 실시간 성능 지표
┌─────────────────────────┐
│ 🚀 평균 로딩 시간        │
│ 2.1초 (목표: 3초 이하)   │
│                         │
│ 💾 캐시 적중률          │
│ 73% (목표: 70% 이상)    │
│                         │
│ 📱 메모리 사용량        │
│ 156MB (목표: 200MB 이하) │
│                         │
│ 🌐 오프라인 사용률       │
│ 91% (목표: 90% 이상)    │
└─────────────────────────┘
```

### 11-2. 사용자 경험 추적
- **Core Web Vitals:** FCP, LCP, CLS 지표 모니터링
- **사용자 이탈률:** 로딩 지연으로 인한 화면 이탈 추적
- **에러 로그:** 캐시 관련 오류 및 메모리 부족 이슈
- **A/B 테스트:** 캐시 정책별 성능 차이 실험

---

## 12. 장애 대응

### 12-1. 장애 시나리오
```
네트워크 장애:
├── 완전 오프라인 → 캐시 모드 자동 전환
├── 느린 네트워크 → 타임아웃 단축, 캐시 우선
└── 불안정 연결 → 재시도 로직, 점진적 백오프

서버 장애:
├── API 오류 → 캐시 데이터로 임시 대체
├── CDN 장애 → 대체 CDN으로 이미지 제공
└── DB 장애 → 읽기 전용 캐시 모드

클라이언트 장애:
├── 메모리 부족 → 캐시 긴급 정리
├── 저장공간 부족 → 자동 캐시 크기 축소
└── 앱 크래시 → 다음 실행 시 캐시 무결성 검사
```

### 12-2. 복구 전략
- **점진적 복구:** 네트워크 복구 시 단계적 동기화
- **데이터 검증:** 캐시와 서버 데이터 일관성 체크
- **사용자 안내:** 장애 상황과 예상 복구 시간 투명 공개

---

## 13. 보안 고려사항

### 13-1. 캐시 보안
- **민감정보 제외:** 개인정보, 토큰은 캐시하지 않음
- **암호화 저장:** 로컬 캐시는 AES 암호화
- **접근 제어:** 앱 언인스톨 시 캐시 자동 삭제
- **무결성 검증:** 캐시 데이터 변조 감지

### 13-2. 개인정보 보호
- **최소 저장 원칙:** 필요한 데이터만 로컬 저장
- **자동 만료:** 개인 관련 캐시는 짧은 TTL 설정
- **사용자 제어:** 언제든 캐시 삭제 가능
- **투명성:** 무엇이 저장되는지 명시

---

## 14. 용어 사전(Glossary)
- **캐시 적중률:** 전체 요청 중 캐시에서 처리된 비율
- **TTL (Time To Live):** 캐시 데이터의 유효 기간
- **CDN (Content Delivery Network):** 전 세계 분산 서버 네트워크
- **지연 로딩:** 화면에 보이는 시점에 데이터를 로딩하는 방식
- **백그라운드 동기화:** 사용자가 모르는 사이 데이터를 업데이트하는 것

---

## 15. 기술 제약
- **모바일 메모리:** iOS/Android 앱당 사용 가능 메모리 제한
- **저장 공간:** 사용자 기기의 가용 저장 공간 의존
- **네트워크 정책:** 통신사별 데이터 제한 및 속도 제한
- **플랫폼 제한:** iOS/Android별 백그라운드 작업 제약

---

## Changelog
- 2025-01-XX: 초기 문서 작성 (작성자: Claude)
